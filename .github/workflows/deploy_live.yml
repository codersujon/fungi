name: üöÄ SSH Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üéâ Deploy to live.codersujon.com
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, curl, intl, mysql, zip
          tools: composer

      - name: üß∞ Setup Node.js (Latest LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: üîê Setup SSH and Copy Deploy Key to Server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 22692 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          # Deploy key ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßá‡¶≠
          echo "${{ secrets.DEPLOY_KEY_GITHUB }}" > ~/.ssh/github-deploy-key
          chmod 600 ~/.ssh/github-deploy-key

          # Deploy key ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
          scp -P 22692 ~/.ssh/github-deploy-key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/.ssh/github-deploy-key
          ssh -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "chmod 600 /home/${{ secrets.SSH_USER }}/.ssh/github-deploy-key"

      - name: üöÄ Deploy & Build on Remote Server
        run: |
          ssh -i ~/.ssh/id_rsa -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e  # ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶´‡ßá‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß

            cd /home/${USER}

            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github-deploy-key"

            if [ ! -d "live.codersujon.com/.git" ]; then
              echo "üì• Cloning fresh Laravel repo..."
              git clone git@github.com:codersujon/fungi.git live.codersujon.com
            else
              echo "üîÑ Pulling latest code..."
              cd live.codersujon.com
              git reset --hard
              git pull origin main
            fi

            cd live.codersujon.com

            echo "üõ†Ô∏è Laravel Setup"
            php -r "file_exists('.env') || copy('.env.example', '.env');"
            composer install --no-interaction --prefer-dist --optimize-autoloader

            echo "üî® Building Frontend"
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            npm run build

            echo "üõë Maintenance Mode ON"
            php artisan down || true

            echo "üßπ Clearing old caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            echo "‚öôÔ∏è Laravel Optimize"
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "‚úÖ Maintenance Mode OFF"
            php artisan up
          EOF

      - name: üå± Run Seeder
        run: |
          ssh -i ~/.ssh/id_rsa -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/${USER}/live.codersujon.com
            php artisan db:seed --force
          EOF

      - name: üåê Health Check
        run: |
          echo "üîç Checking application health at https://live.codersujon.com"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://live.codersujon.com/)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Health check failed with HTTP status $STATUS"
            exit 1
          fi
          echo "‚úÖ Health check passed with status $STATUS"
