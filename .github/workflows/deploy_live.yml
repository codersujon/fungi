name: 🚀 SSH Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: 🎉 Deploy to live.codersujon.com
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🐘 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, curl, intl, mysql, zip
          tools: composer

      - name: 🧰 Setup Node.js (Latest LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: 🔐 Setup SSH and Copy Deploy Key to Server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 22692 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          echo "${{ secrets.DEPLOY_KEY_GITHUB }}" > ~/.ssh/github-deploy-key
          chmod 600 ~/.ssh/github-deploy-key

          scp -P 22692 ~/.ssh/github-deploy-key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/.ssh/github-deploy-key
          ssh -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "chmod 600 /home/${{ secrets.SSH_USER }}/.ssh/github-deploy-key"

      - name: 🚀 Deploy & Build on Remote Server
        run: |
          ssh -i ~/.ssh/id_rsa -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            cd /home/${USER}

            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github-deploy-key"

            if [ ! -d "live.codersujon.com/.git" ]; then
              echo "📥 Cloning fresh Laravel repo..."
              git clone git@github.com:codersujon/fungi.git live.codersujon.com
            else
              echo "🔄 Pulling latest code..."
              cd live.codersujon.com
              git reset --hard
              git pull origin main
            fi

            php artisan key:generate --force
            php artisan cache:table || true
            php artisan migrate --force


            php artisan down || true

            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            php artisan up
          EOF

      - name: 🌱 Run Seeder
        run: |
          ssh -i ~/.ssh/id_rsa -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/${USER}/live.codersujon.com
            php artisan migrate:fresh --seed
          EOF

      - name: 🌐 Health Check
        run: |
          echo "🔍 Checking application health at https://live.codersujon.com"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://live.codersujon.com/)
          if [ "$STATUS" != "200" ]; then
            echo "❌ Health check failed with HTTP status $STATUS"
            exit 1
          fi
          echo "✅ Health check passed with status $STATUS"
