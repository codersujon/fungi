name: 🚀 SSH Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: 🎉 Deploy to live.codersujon.com
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🐘 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, curl, intl, mysql, zip
          tools: composer

      - name: 🧰 Setup Node.js (Latest LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: 🧪 Install PHP Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: 🗂 Set Directory Permissions
        run: chmod -R ug+rwx storage bootstrap/cache

      - name: 💻 Install and Build Frontend
        run: |
          npm ci
          npm run build

      - name: 🔐 Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 22692 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: 🚀 SSH Deploy & Laravel Optimize
        run: |
          ssh -i ~/.ssh/id_rsa -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/codersuj/live.codersujon.com

            if [ ! -f artisan ]; then
              echo "❌ artisan file not found! Laravel is not deployed here."
              exit 1
            fi

            echo "🛑 Putting Laravel app in maintenance mode..."
            php artisan down || true

            echo "🧹 Clearing old caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            echo "⚙️ Caching configurations..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "✅ Bringing Laravel app back online..."
            php artisan up
          EOF

      - name: 🌱 Run Seeder
        run: |
          ssh -i ~/.ssh/id_rsa -p 22692 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /live.codersujon.com
            php artisan db:seed --force
          EOF

      - name: 🌐 Health Check
        run: |
          echo "🔍 Checking application health at https://live.codersujon.com"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://live.codersujon.com/)
          if [ "$STATUS" != "200" ]; then
            echo "❌ Health check failed with HTTP status $STATUS"
            exit 1
          fi
          echo "✅ Health check passed with status $STATUS"
